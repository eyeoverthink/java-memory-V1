/* ═══════════════════════════════════════════════════════════ */
/* FRAY-ARCADE: MULTI-GAME SYSTEM                              */
/* One Engine. Infinite Fun.                                   */
/* Generated by Fraymus Agent Brain v3.0                       */
/* φ^75 Validation Seal: 4721424167835376.00                  */
/* ═══════════════════════════════════════════════════════════ */

/* ═══════════════════════════════════════════════════════════ */
/* GLOBAL STATE                                                 */
/* ═══════════════════════════════════════════════════════════ */

int game_state = 0;  /* 0=Menu, 1=Pong, 2=Snake, 3=Invaders */
int score = 0;
int high_score = 0;
int game_tick = 0;
int deaths = 0;

/* ═══════════════════════════════════════════════════════════ */
/* GAME 1: PONG                                                 */
/* ═══════════════════════════════════════════════════════════ */

int p1_y = 10, p2_y = 10;
int ball_x = 40, ball_y = 12;
int ball_dx = 1, ball_dy = 1;

void update_pong() {
    /* Move ball */
    ball_x += ball_dx;
    ball_y += ball_dy;
    
    /* Wall collision */
    if(ball_y <= 1 || ball_y >= 23) {
        ball_dy = -ball_dy;
    }
    
    /* Paddle collision */
    if(ball_x == 2 && ball_y >= p1_y && ball_y <= p1_y + 3) {
        ball_dx = -ball_dx;
        score++;
    }
    if(ball_x == 78 && ball_y >= p2_y && ball_y <= p2_y + 3) {
        ball_dx = -ball_dx;
    }
    
    /* Score/reset */
    if(ball_x < 0 || ball_x > 80) {
        if(ball_x < 0) {
            /* P2 scored */
            deaths++;
            log_game_event("PONG", "LOST");
        }
        ball_x = 40;
        ball_y = 12;
        score = 0;
    }
}

void draw_pong() {
    kclear();
    
    /* Draw paddles */
    for(int i = 0; i < 4; i++) {
        draw_char(1, p1_y + i, '|');
        draw_char(79, p2_y + i, '|');
    }
    
    /* Draw ball */
    draw_char(ball_x, ball_y, 'O');
    
    /* Draw score */
    kprint("Score: ");
    char buf[16];
    int_to_str(score, buf);
    kprint(buf);
}

/* ═══════════════════════════════════════════════════════════ */
/* GAME 2: SNAKE                                                */
/* ═══════════════════════════════════════════════════════════ */

int snake_x[100], snake_y[100];
int snake_len = 3;
int snake_dir = 0;  /* 0=Right, 1=Down, 2=Left, 3=Up */
int food_x = 10, food_y = 10;

void update_snake() {
    /* Move body */
    for(int i = snake_len; i > 0; i--) {
        snake_x[i] = snake_x[i - 1];
        snake_y[i] = snake_y[i - 1];
    }
    
    /* Move head */
    if(snake_dir == 0) snake_x[0]++;
    if(snake_dir == 1) snake_y[0]++;
    if(snake_dir == 2) snake_x[0]--;
    if(snake_dir == 3) snake_y[0]--;
    
    /* Wrap around */
    if(snake_x[0] < 0) snake_x[0] = 79;
    if(snake_x[0] > 79) snake_x[0] = 0;
    if(snake_y[0] < 0) snake_y[0] = 23;
    if(snake_y[0] > 23) snake_y[0] = 0;
    
    /* Eat food */
    if(snake_x[0] == food_x && snake_y[0] == food_y) {
        snake_len++;
        score += 10;
        food_x = (food_x + 7) % 78;
        food_y = (food_y + 5) % 22;
    }
    
    /* Self-collision */
    for(int i = 1; i < snake_len; i++) {
        if(snake_x[0] == snake_x[i] && snake_y[0] == snake_y[i]) {
            deaths++;
            log_game_event("SNAKE", "DIED");
            snake_len = 3;
            score = 0;
        }
    }
}

void draw_snake() {
    kclear();
    
    /* Draw food */
    draw_char(food_x, food_y, '*');
    
    /* Draw snake */
    for(int i = 0; i < snake_len; i++) {
        draw_char(snake_x[i], snake_y[i], '#');
    }
    
    /* Draw score */
    kprint("Score: ");
    char buf[16];
    int_to_str(score, buf);
    kprint(buf);
}

/* ═══════════════════════════════════════════════════════════ */
/* GAME 3: SPACE INVADERS                                       */
/* ═══════════════════════════════════════════════════════════ */

int ship_x = 40;
int bullets[10][2];  /* [x, y] */
int bullet_count = 0;
int aliens[5][10];   /* 1=Alive, 0=Dead */
int alien_x = 10, alien_y = 2;
int alien_dx = 1;

void init_invaders() {
    for(int r = 0; r < 5; r++) {
        for(int c = 0; c < 10; c++) {
            aliens[r][c] = 1;
        }
    }
}

void update_invaders() {
    /* Move bullets */
    for(int i = 0; i < 10; i++) {
        if(bullets[i][1] > 0) {
            bullets[i][1]--;
        }
    }
    
    /* Move aliens */
    alien_x += alien_dx;
    if(alien_x <= 0 || alien_x >= 60) {
        alien_dx = -alien_dx;
        alien_y++;
    }
    
    /* Check collisions */
    for(int b = 0; b < 10; b++) {
        if(bullets[b][1] > 0) {
            for(int r = 0; r < 5; r++) {
                for(int c = 0; c < 10; c++) {
                    if(aliens[r][c] && 
                       bullets[b][0] == alien_x + c * 2 &&
                       bullets[b][1] == alien_y + r) {
                        aliens[r][c] = 0;
                        bullets[b][1] = 0;
                        score += 10;
                    }
                }
            }
        }
    }
}

void draw_invaders() {
    kclear();
    
    /* Draw ship */
    draw_char(ship_x, 23, 'A');
    
    /* Draw aliens */
    for(int r = 0; r < 5; r++) {
        for(int c = 0; c < 10; c++) {
            if(aliens[r][c]) {
                draw_char(alien_x + c * 2, alien_y + r, 'M');
            }
        }
    }
    
    /* Draw bullets */
    for(int i = 0; i < 10; i++) {
        if(bullets[i][1] > 0) {
            draw_char(bullets[i][0], bullets[i][1], '|');
        }
    }
}

/* ═══════════════════════════════════════════════════════════ */
/* AI ANALYST                                                   */
/* ═══════════════════════════════════════════════════════════ */

void log_game_event(const char* game, const char* event) {
    /* Write to FrayFS for FrayLLM analysis */
    /* write_file("gamelog.txt", ...); */
    
    kprint("[AI] ANALYZING: ");
    kprint(game);
    kprint(" -> ");
    kprint(event);
    kprint("\n");
    
    /* AI tips based on patterns */
    if(deaths > 3) {
        kprint("[AI] TIP: Your reaction time is slowing. ");
        kprint("Try anticipating the bounce.\n");
    }
}

/* ═══════════════════════════════════════════════════════════ */
/* MAIN ARCADE LOOP                                             */
/* ═══════════════════════════════════════════════════════════ */

void start_arcade() {
    init_vga();
    init_invaders();
    
    kprint("[ARCADE] System ready\n");
    
    while(1) {
        if(game_state == 0) {
            /* Menu */
            kclear();
            kprint("═══ FRAY ARCADE ═══\n\n");
            kprint("1. Pong\n");
            kprint("2. Snake\n");
            kprint("3. Space Invaders\n\n");
            kprint("Select: ");
            
            char c = get_char();
            if(c == '1') game_state = 1;
            if(c == '2') game_state = 2;
            if(c == '3') game_state = 3;
            
            score = 0;
        }
        else if(game_state == 1) {
            update_pong();
            draw_pong();
            for(volatile int i = 0; i < 50000; i++);
        }
        else if(game_state == 2) {
            update_snake();
            draw_snake();
            for(volatile int i = 0; i < 100000; i++);
        }
        else if(game_state == 3) {
            update_invaders();
            draw_invaders();
            for(volatile int i = 0; i < 50000; i++);
        }
        
        /* Global input */
        char key = get_char_non_blocking();
        
        if(key == 'q') game_state = 0;  /* Quit to menu */
        
        /* Pong controls */
        if(game_state == 1) {
            if(key == 'w' && p1_y > 1) p1_y--;
            if(key == 's' && p1_y < 20) p1_y++;
            /* AI opponent */
            if(p2_y < ball_y) p2_y++;
            if(p2_y > ball_y) p2_y--;
        }
        
        /* Snake controls */
        if(game_state == 2) {
            if(key == 'w') snake_dir = 3;
            if(key == 's') snake_dir = 1;
            if(key == 'a') snake_dir = 2;
            if(key == 'd') snake_dir = 0;
        }
        
        /* Invaders controls */
        if(game_state == 3) {
            if(key == 'a' && ship_x > 0) ship_x--;
            if(key == 'd' && ship_x < 79) ship_x++;
            if(key == ' ') {
                /* Fire bullet */
                for(int i = 0; i < 10; i++) {
                    if(bullets[i][1] == 0) {
                        bullets[i][0] = ship_x;
                        bullets[i][1] = 22;
                        break;
                    }
                }
            }
        }
        
        game_tick++;
    }
}
