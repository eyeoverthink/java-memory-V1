<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>FRAYMUS NEURAL FORGE // GEN 187</title>
    <style>
        /* --- AESTHETIC: LIVEWIRE --- */
        body { margin: 0; overflow: hidden; background: #050505; font-family: 'Consolas', monospace; color: #00FF00; display: flex; height: 100vh; }

        /* LEFT: INPUT & CONTROLS */
        #control-panel {
            width: 300px; background: #080808; border-right: 1px solid #004400;
            display: flex; flex-direction: column; padding: 20px; z-index: 10;
        }

        textarea {
            background: #111; border: 1px solid #333; color: #EEE; font-family: inherit; font-size: 12px;
            padding: 10px; resize: none; outline: none; height: 150px; margin-bottom: 20px;
        }
        textarea:focus { border-color: #00FF00; }

        /* BUTTON GRID */
        .btn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }

        button {
            background: #002200; color: #00FF00; border: 1px solid #00FF00; padding: 15px; cursor: pointer;
            font-weight: bold; letter-spacing: 1px; transition: 0.2s; font-size: 10px;
        }
        button:hover { background: #00FF00; color: #000; box-shadow: 0 0 20px #00FF00; }
        button:disabled { border-color: #555; color: #555; background: #111; cursor: not-allowed; box-shadow: none; }

        #ignite-btn { grid-column: span 2; font-size: 12px; letter-spacing: 3px; }

        /* RIGHT: THE CANVAS (VISUALIZER) */
        #visualizer { flex-grow: 1; position: relative; background: #000; }
        canvas { display: block; width: 100%; height: 100%; }

        /* OUTPUT OVERLAY (The "Paper") */
        #output-layer {
            position: absolute; top: 20px; left: 20px; bottom: 20px; right: 20px;
            pointer-events: none; overflow-y: auto; padding-bottom: 50px;
            font-size: 14px; line-height: 1.5; color: #E0E0E0; white-space: pre-wrap;
            text-shadow: 0 0 5px rgba(0, 255, 0, 0.5);
        }

        /* CURSOR BLINK */
        .cursor { display: inline-block; width: 8px; height: 16px; background: #00FF00; animation: blink 1s infinite; vertical-align: middle; }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }
    </style>
</head>
<body>

<div id="control-panel">
    <div style="font-size:18px; font-weight:bold; margin-bottom:20px; color:#00FF00;">NEURAL FORGE</div>
    <div style="font-size:10px; color:#666; margin-bottom:5px;">INPUT PROMPT</div>
    <textarea id="prompt" placeholder="Ask Fraymus to write code..."></textarea>

    <div class="btn-grid">
        <button id="ignite-btn" onclick="streamThought()">IGNITE STREAM</button>
        <button onclick="copyToClipboard()">COPY</button>
        <button onclick="exportFile()">EXPORT FILE</button>
    </div>

    <div id="status" style="margin-top:20px; font-size:10px; color:#444;">STATUS: DISCONNECTED</div>
</div>

<div id="visualizer">
    <canvas id="simCanvas"></canvas>
    <div id="output-layer"><span id="stream-text"></span><span class="cursor"></span></div>
</div>

<script>
    /**
     * ðŸ§¬ FRAYMUS NEURAL FORGE // GEN 187
     * Logic: Stream -> Visualize -> Export.
     */

    const canvas = document.getElementById('simCanvas');
    const ctx = canvas.getContext('2d');
    let width, height;

    // --- STATE ---
    let particles = [];
    let connections = [];
    let isStreaming = false;
    let generatedText = "";
    const API_URL = "http://localhost:11434/api/generate";
    const MODEL = "eyeoverthink/fraymus-recursive"; // Your Model

    // --- EXPORT LOGIC (The New Brain) ---
    function copyToClipboard() {
        if(!generatedText) return;
        navigator.clipboard.writeText(generatedText).then(() => {
            setStatus("COPIED TO CLIPBOARD", "#00FF00");
            spawnBurst(width/2, height/2, 20); // Visual feedback
        });
    }

    function exportFile() {
        if(!generatedText) return;

        // Auto-detect extension based on content (Simple heuristic)
        let ext = "txt";
        if(generatedText.includes("def ") || generatedText.includes("import ")) ext = "py";
        if(generatedText.includes("function") || generatedText.includes("const ")) ext = "js";
        if(generatedText.includes("<!DOCTYPE html>")) ext = "html";
        if(generatedText.includes("#include")) ext = "cpp";

        const blob = new Blob([generatedText], { type: "text/plain" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `fraymus_artifact.${ext}`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        setStatus("FILE EXPORTED: " + ext.toUpperCase(), "#0088FF");
        spawnBurst(width/2, height/2, 50); // Big burst
    }

    // --- PARTICLE ENGINE ---
    class TokenParticle {
        constructor(x, y) {
            this.x = x;
            this.y = y;
            this.vx = (Math.random()-0.5) * 10;
            this.vy = (Math.random()-0.5) * 10;
            this.life = 1.0;
            this.color = `hsl(${Math.random()*60 + 100}, 100%, 50%)`; // Green-Cyan spectrum
        }
        update() {
            this.x += this.vx;
            this.y += this.vy;
            this.life -= 0.02;
        }
        draw() {
            ctx.globalAlpha = this.life;
            ctx.fillStyle = this.color;
            ctx.fillRect(this.x, this.y, 3, 3);
            ctx.globalAlpha = 1.0;
        }
    }

    // --- STREAM LOGIC ---
    async function streamThought() {
        const prompt = document.getElementById('prompt').value;
        if(!prompt) return;

        // Reset UI
        const out = document.getElementById('stream-text');
        out.innerText = "";
        generatedText = ""; // Clear buffer
        document.getElementById('ignite-btn').disabled = true;
        document.getElementById('ignite-btn').innerText = "STREAMING...";
        setStatus("OPENING NEURAL TUNNEL...", "#00FFFF");
        isStreaming = true;

        try {
            const response = await fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    model: MODEL,
                    prompt: prompt,
                    stream: true // THE KEY UPGRADE
                })
            });

            if (!response.ok) throw new Error("Connection Failed");

            const reader = response.body.getReader();
            const decoder = new TextDecoder();

            setStatus("NEURAL LINK ACTIVE", "#00FF00");

            // STREAM READER LOOP
            while (true) {
                const { done, value } = await reader.read();
                if (done) break;

                const chunk = decoder.decode(value, { stream: true });
                const lines = chunk.split('\n');

                for (const line of lines) {
                    if (!line) continue;
                    try {
                        const json = JSON.parse(line);
                        if (json.response) {
                            // 1. UPDATE DATA
                            const txt = json.response;
                            out.innerText += txt;
                            generatedText += txt; // Build buffer for export

                            // 2. TRIGGER VISUALS
                            spawnBurst(width/2 + (Math.random()-0.5)*200, height/2 + (Math.random()-0.5)*200);

                            // Auto scroll
                            const overlay = document.getElementById('output-layer');
                            overlay.scrollTop = overlay.scrollHeight;
                        }
                        if (json.done) {
                            setStatus("TRANSMISSION COMPLETE", "#008800");
                        }
                    } catch (e) {
                        console.error("Parse error", e);
                    }
                }
            }

        } catch (e) {
            setStatus("ERROR: " + e.message, "#FF0000");
            document.getElementById('stream-text').innerText += "\n\n[CONNECTION LOST]\nEnsure 'ollama serve' is running with OLLAMA_ORIGINS=\"*\"";
        } finally {
            document.getElementById('ignite-btn').disabled = false;
            document.getElementById('ignite-btn').innerText = "IGNITE STREAM";
            isStreaming = false;
        }
    }

    // --- VISUALIZATION LOOP ---
    function spawnBurst(x, y, count=5) {
        for(let i=0; i<count; i++) {
            particles.push(new TokenParticle(x, y));
        }
        // Add "Neural Line"
        connections.push({x: x, y: y, life: 1.0});
    }

    function loop() {
        // Clear with trail
        ctx.fillStyle = "rgba(0, 0, 0, 0.1)";
        ctx.fillRect(0, 0, width, height);

        // Update Particles
        for (let i = particles.length - 1; i >= 0; i--) {
            let p = particles[i];
            p.update();
            p.draw();
            if (p.life <= 0) particles.splice(i, 1);
        }

        // Update Connections (The Web)
        ctx.lineWidth = 1;
        for (let i = connections.length - 1; i >= 0; i--) {
            let c = connections[i];
            if (i > 0) {
                let prev = connections[i-1];
                ctx.beginPath();
                ctx.strokeStyle = `rgba(0, 255, 0, ${c.life * 0.5})`;
                ctx.moveTo(c.x, c.y);
                ctx.lineTo(prev.x, prev.y);
                ctx.stroke();
            }
            c.life -= 0.05;
            if (c.life <= 0) connections.splice(i, 1);
        }

        requestAnimationFrame(loop);
    }

    function setStatus(msg, col) {
        const el = document.getElementById('status');
        el.innerText = "STATUS: " + msg;
        el.style.color = col;
    }

    function resize() {
        width = document.getElementById('visualizer').clientWidth;
        height = document.getElementById('visualizer').clientHeight;
        canvas.width = width; canvas.height = height;
    }
    window.addEventListener('resize', resize);

    // BOOT
    resize();
    loop();

</script>
</body>
</html>